<div class="mx-auto max-w-3xl p-4 space-y-8">
  <h1 class="text-2xl font-semibold">Ask Anything</h1>

  <% begin %>
    <% user = @users.first || User.first %>
    <% has_google = user && Credential.exists?(user_id: user.id, provider: "google") %>
    <div class="mb-4 p-3 border rounded bg-gray-50">
      <% if has_google %>
        <span class="text-green-700 font-medium">Google connected</span>
        <span class="text-sm text-gray-600 ml-2">(Gmail & Calendar read-only)</span>
      <% else %>
        <a href="<%= auth_google_path %>" class="inline-block bg-indigo-600 text-white px-3 py-2 rounded">
          Connect Google
        </a>
        <span class="text-sm text-gray-600 ml-2">Gmail & Calendar (read-only)</span>
      <% end %>
    </div>
  <% rescue => e %>
    <div class="text-red-600 text-sm">UI hint error: <%= e.message %></div>
  <% end %>

  <div class="grid gap-6">
    <!-- Create embedding -->
    <div class="p-4 border rounded">
      <h2 class="font-medium mb-2">Create embedding</h2>
      <form action="/embeddings" method="post" class="space-y-2">
        <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="text-sm">User</label>
            <select name="embedding[user_id]" class="w-full border rounded p-2">
              <% @users.each do |u| %>
                <option value="<%= u.id %>"><%= u.email %> (#<%= u.id %>)</option>
              <% end %>
            </select>
          </div>
          <div>
            <label class="text-sm">Kind</label>
            <input name="embedding[kind]" value="note" class="w-full border rounded p-2" />
          </div>
          <div>
            <label class="text-sm">Ref ID</label>
            <input name="embedding[ref_id]" value="demo-1" class="w-full border rounded p-2" />
          </div>
        </div>
        <div>
          <label class="text-sm">Content (text to embed)</label>
          <textarea name="embedding[content]" rows="3" class="w-full border rounded p-2" placeholder="Write some text..."></textarea>
        </div>
        <div>
          <label class="text-sm">Chunk (stored original)</label>
          <textarea name="embedding[chunk]" rows="2" class="w-full border rounded p-2" placeholder="Optional, usually same as content"></textarea>
        </div>
        <button class="bg-blue-600 text-white px-3 py-2 rounded">Create</button>
      </form>
    </div>

    <!-- Nearest search (Turbo Streams) -->
    <div class="p-4 border rounded">
      <h2 class="font-medium mb-2">Nearest search</h2>

      <!-- IMPORTANT: no data-turbo="false". Let Turbo handle the response -->
      <!-- Target the turbo-frame below so results update in-place -->
      <form action="/embeddings/nearest" method="post" class="space-y-2" data-turbo-frame="nearest_results">
        <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">

        <div>
          <label class="text-sm">Query text</label>
          <textarea name="query_text" rows="3" class="w-full border rounded p-2" placeholder="Try: baseball, meeting, AAPL, kickoff, review"></textarea>
        </div>

        <div class="grid grid-cols-3 gap-2">
          <div>
            <label class="text-sm">Top K</label>
            <input name="limit" value="5" class="w-full border rounded p-2" />
          </div>
          <div>
            <label class="text-sm">Distance</label>
            <select name="distance" class="w-full border rounded p-2">
              <option value="cosine" selected>cosine</option>
              <option value="l2">l2</option>
              <option value="ip">ip</option>
            </select>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <button class="bg-emerald-600 text-white px-3 py-2 rounded">Search</button>

          <!-- Optional: open JSON in a new tab for debugging -->
          <!-- Keeps your API behavior available -->
          <button
            formaction="/embeddings/nearest"
            formmethod="post"
            formtarget="_blank"
            data-turbo="false"
            class="text-sm underline">
            Open JSON
          </button>
        </div>
      </form>

      <!-- Results frame: server will turbo_stream.update this frame -->
      <turbo-frame id="nearest_results" class="block mt-4">
        <div class="text-sm text-gray-500">Enter a query and press Search.</div>
      </turbo-frame>

      <div class="mt-4">
        <h3 class="font-medium">Recent</h3>
        <ul class="text-sm list-disc pl-6">
          <% @recent.each do |e| %>
            <li>#<%= e.id %> • user:<%= e.user_id %> • <%= e.kind %>/<%= e.ref_id %></li>
          <% end %>
        </ul>
      </div>
    </div>
  </div>
</div>
